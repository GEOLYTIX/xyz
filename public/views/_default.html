<!doctype html>
<html lang="{{language}}">
  <head data-dir="{{dir}}" data-login="{{login}}">
    <title>{{title}}</title>

    <link
      rel="icon"
      type="image/x-icon"
      href="{{dir}}/public/icons/favicon.ico"
    >
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    >

    <link
      rel="preload"
      href="{{dir}}/public/css/material-icons-outlined.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    >
    <link
      rel="preload"
      href="{{dir}}/public/css/titillium-web-v19-latin_latin-ext-regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    >
    <link
      rel="preload"
      href="{{dir}}/public/css/titillium-web-v19-latin_latin-ext-italic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    >

    <script
      src="https://cdn.jsdelivr.net/npm/ol@v10.6.1/dist/ol.js"
      integrity="sha384-R02sHnzL8yl/uvLZvMsfgBOMBIOOHLpuLNo4dLuWQWFun1sxEWJej+SPwiGxaeGd"
      crossorigin="anonymous"
    ></script>

    <!-- Load XYZ / MAPP stylesheet and library. -->
    <link rel="stylesheet" href="{{dir}}/public/css/mapp.css">
    <link rel="stylesheet" href="{{dir}}/public/css/ui.css">

    <script type="module" src="{{dir}}/public/js/lib/mapp.js" defer></script>
    <script type="module" src="{{dir}}/public/js/lib/ui.js" defer></script>

    <style>
    html {
      position: fixed;
      bottom: 0%;
      top: 0%;
      height: 100%;
      width: 100%;
    }

    #Map {
      position: relative;
    }

    #Map .ol-scale-line {
      right: 5px;
      top: 5px;
      position: fixed;
    }

    #ctrls-divider {
      grid-row: 1 / 4;
      grid-column: 2;
      background-color: var(--color-base-secondary);
      background-image: url('data:image/svg+xml,<svg viewBox="0 0 10 100" xmlns="http://www.w3.org/2000/svg">%0A  <line x1="5" y1="10" x2="5" y2="90" stroke-width="3" stroke="%23888" stroke-linecap="round"/>%0A</svg>');
      background-repeat: no-repeat;
      background-position: center;
      box-shadow: 3px 0px 6px -3px var(--color-base-tertiary);
      isolation: isolate;

      &:hover {
        cursor: col-resize;
      }
    }

    #tabview-divider {
      position: relative;
      grid-row: 2;
      grid-column: 3;
      background-image: url('data:image/svg+xml,<svg viewBox="0 0 100 10" xmlns="http://www.w3.org/2000/svg">%0A  <line x1="10" y1="5" x2="90" y2="5" stroke-width="3" stroke="%23888" stroke-linecap="round"/>%0A</svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-color: var(--color-base-tertiary);
      box-shadow: 0px -1px 6px -3px var(--color-base-tertiary);

      &:hover {
        cursor: row-resize;
      }
    }

    @media only screen and (min-width: 768px) {
      body {
        display: grid;
        grid-template-columns: 350px 10px auto;
      }

      body.fullscreen {
        grid-template-columns: 0 0 auto !important;
      }

      body.fullscreen #ctrls {
        display: none;
      }

      #Map {
        grid-row: 1;
        grid-column: 3;
        position: relative;
      }

      #OL {
        width: 100%;
        height: 100vh;
        position: absolute;
      }

      #ctrl-panel {
        transform: rotateY(180deg);
      }

      #ctrl-panel>div {
        transform: rotateY(180deg);
      }

      #ctrls {
        grid-row: 1/4;
        grid-column: 1;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #Tabview {
        grid-row: 3;
        grid-column: 3;
      }
    }

    @media only screen and (max-width: 768px) {
      html {
        overflow: scroll;
      }

      body {
        overflow-y: scroll;
        overflow-x: hidden;
      }

      #Map {
        height: calc(100% - 40px);
        width: 100%;
      }

      #OL {
        width: 100%;
        height: 100%;
      }

      #ctrls {
        width: 100%;
        height: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        background-color: inherit;
      }
    }
  </style>
  </head>

  <body style="grid-template-rows: auto 0 0">
    <div id="Map">
      <div id="OL"></div>
      <div id="mapButton" class="btn-column"></div>
    </div>

    <div id="tabview-divider"></div>

    <div
      id="Tabview"
      class="tabview mobile-display-none desktop-display-none"
    ></div>

    <div id="ctrls-divider" class="mobile-display-none"></div>

    <div id="ctrls"></div>

    <script type="module">
    console.log(`MAPP v${mapp.version}`);

    // Set the maxWidth for mobile responsive display.
    mapp.utils.mobile(765);

    // Refresh cookie and get user with updated credentials.
    await mapp.utils.xhr(`${mapp.host}/api/user/cookie`).then((user) => {
      // The cookie request will Err without an ACL being configured for public access.
      mapp.user = user instanceof Error ? false : user;
    });

    // Get user object stored in the userIndexedDB
    const storedUser = await mapp.utils.userIndexedDB.get({
      store: 'user',
      name: mapp.user?.email || 'anonymous',
    });

    // Assign storedUser into mapp.user to overwrite custom user properties.
    if (storedUser?.email) {
      mapp.user = { ...mapp.user, ...storedUser };
    }

    // Language as URL parameter will override user language.
    mapp.language = mapp.hooks.current.language || mapp.user?.language || 'en';

    // Load dictionary if language other than English.
    if (mapp.language !== 'en') {
      await mapp.utils.loadDictionary(mapp.language);
    }

    if (!Object.hasOwn(mapp.dictionaries, mapp.language)) {
      console.warn(`'${mapp.user.language}' mapp.language is not supported by mapp.dictionaries.`);
    }

    // Restore scroll
    if ('scrollRestoration' in history) history.scrollRestoration = 'auto';

    // Set Openlayers node in order to move map object.
    const OL = document.getElementById('OL');

    // Move map up on document scroll
    document.body.addEventListener('scroll', () => {
      OL.style['marginTop'] = `-${parseInt(window.pageYOffset / 2)}px`;

      // Limit scrollTop on mobile browser
      if (document.body.scrollTop > window.innerHeight) {
        document.body.scrollTop = window.innerHeight;
      }
    });

    // ResizeHandler for #CTRLS
    mapp.ui.utils.resizeHandler({
      target: document.getElementById('ctrls-divider'),
      doubleClickClose: true,
    });

    // ResizeHandler for tabview
    mapp.ui.utils.resizeHandler({
      target: document.getElementById('tabview-divider'),
      axis: 'Y'
    });

    const tabview = document.getElementById('Tabview');

    mapp.ui.Tabview({
      node: tabview,
      id: 'tabview',
      showTab: () => {
        // Show the tabview if not already visible.
        if (tabview.classList.contains('desktop-display-none')) {
          tabview.classList.remove('desktop-display-none');
          document.body.style.gridTemplateRows = 'auto 10px 200px';
        }
      },
      removeLastTab: () => {
        // Hide tabview if tab had no siblings.
        tabview.classList.add('desktop-display-none');
        document.body.style.gridTemplateRows = 'auto 0 0';
        mapview.Map.getTargetElement().style.marginTop = 0;
      },
    });

    // Get list of accessible locales from Workspace API.
    let locales = await mapp.utils.xhr(
      `${mapp.host}/api/workspace/locales`,
    );

      // Assign locale from current [URL parameter] or as first key from locales array.
    let locale = mapp.hooks.current.locale || locales[0]?.key

    // Use 'locale' as default if undefined.
    locale ??= 'locale'

    // Get locale with list of layers from Workspace API.
    locale = await mapp.utils.xhr(
      `${mapp.host}/api/workspace/locale?locale=${locale}&layers=true`,
    );

    if (locale instanceof Error) {
      // Create the Dialog.node
      mapp.ui.elements.dialog({
        css_style:
          'padding: 1em; border-color: #000; z-index:9999; max-width: 50%;',
        content: mapp.dictionary.no_locales,
        target: document.body,
        top: '40%',
        left: '25%',
        contained: true,
      });
    }

    if (mapp.user?.locale instanceof Object) {
      Object.assign(locale, mapp.user?.locale)
    }

    // Check whether the locale supports a userLocale
    if (mapp.hooks.current.userlocale) {
      // Assign the userlocale value as name to check for a stored userlocale
      locale.name = mapp.hooks.current.userlocale;

      // Check whether a userLocale is stored for the current user|workspace
      const userLocale = await mapp.utils.userLocale.get(locale);

      if (userLocale) {
        locale = userLocale;
      }
    }

    const layersPanel = mapp.utils.html.node`<div id="layers" class="active">`

    // Parse the current locale path from the hooks or the loaded locale key
    // mapp.hooks.current.locale is the raw URL string "UK,London" or undefined
    let currentPath = [];
    if (mapp.hooks.current.locale) {
      currentPath = Array.isArray(mapp.hooks.current.locale)
        ? mapp.hooks.current.locale
        : mapp.hooks.current.locale.split(',');
    } else {
      // Use the key from the loaded locale.
      currentPath = Array.isArray(locale.key) ? locale.key : [locale.key];
    }

    // Recursive function to build dependent dropdowns
    async function localeDropdowns(level, list) {
      if (!list || !list.length) return;

      // Construct the expected key for the current selection at this level.
      // For root (level 0), this is just the first segment.
      // For nested (level 1+), it is the cumulative path "A,B".
      const expectedKey = currentPath.slice(0, level + 1).join(',');

      // Find the selected entry object
      const selectedEntry = list.find(l => l.key === expectedKey);

      const dropdown = mapp.ui.elements.dropdown({
        data_id: `locale-dropdown-${level}`,
        // Display short name (last part of path)
        placeholder: selectedEntry
          ? (selectedEntry.name || selectedEntry.key).split(/[/,]/).pop()
          : 'Select Locale',
          entries: list.map(l => ({
          title: (l.name || l.key).split(/[/,]/).pop(),
          key: l.key
        })),
        callback: (e, entry) => {
          window.location.assign(`${mapp.host}?locale=${entry.key}`);
        }
      });

      layersPanel.appendChild(dropdown);

      // If we have a selection at this level, check if we need to show the next level
      if (selectedEntry) {
        // Fetch children for this selection
        const nextList = await mapp.utils.xhr(
          `${mapp.host}/api/workspace/locales?locale=${selectedEntry.key}`
        );

        if (nextList && nextList.length > 0) {
          await localeDropdowns(level + 1, nextList);
        }
      }
    }

    // Initial call for Root level
    await localeDropdowns(0, locales);

    if (!window.ol) await mapp.utils.olScript();

    locale.syncPlugins ??= ['zoomBtn', 'admin', 'login'];

    mapp.hooks.set({locale:locale.key});

    //Create tabs and panels for controls.
    const controlPanel = mapp.ui.elements.control({
      target: document.getElementById('ctrls')
    })

    // Create mapview
    const mapview = await mapp.Mapview({
      host: mapp.host,
      target: OL,
      locale: locale,
      hooks: true,
      scrollWheelZoom: true,
      loadPlugins: true,
      controlPanel,
      mapButton: document.getElementById('mapButton'),
      attribution: {
        target: document.getElementById('Map'),
        logo: mapp.utils.html.node`
        <a class="logo" target="_blank" href="https://geolytix.co.uk">
          <img src="https://geolytix.github.io/public/geolytix_mapp.svg" alt="GEOLYTIX MAPP Logo">`,
        links: {
          [`XYZ v${mapp.version}`]: 'https://github.com/GEOLYTIX/xyz',
          ['SHA']: `https://github.com/GEOLYTIX/xyz/commit/${mapp.hash}`,
          Openlayers: 'https://openlayers.org',
        },
      },
    });

    if (!locale.layers?.length && !(locale instanceof Error)) {
      mapp.ui.elements.dialog({
        css_style:
          'padding: 1em; max-width: 50%;',
        header: mapp.utils.html`<h4>${mapp.dictionary.information}`,
        content: mapp.dictionary.no_layers,
        target: document.body,
        top: '40%',
        left: '25%',
        contained: true,
      });
    }

    // Add layers to mapview.
    await mapview.addLayer(locale.layers);

    controlPanel.add({
      key: 'layers',
      panel: layersPanel
    })

    mapp.ui.layers.listview({
      target: layersPanel,
      layers: mapview.layers,
    });

    if (mapview.locale.gazetteer) {
      const gazPanel =  mapp.utils.html.node`<div id="gazetteer">`;

      controlPanel.add({
        key: 'gazetteer',
        icon: 'search',
        panel: gazPanel,
        focus: 'gazetteer-search-input'
      })

      mapp.ui.Gazetteer(
        Object.assign(mapview.locale.gazetteer, {
          mapview,
          target: gazPanel,
        }),
      );
    }

    const locationsPanel = mapp.utils.html.node`<div id="locations">`

    controlPanel.add({
      key: 'locations',
      icon: 'location_on',
      panel: locationsPanel
    })

    mapp.ui.locations.listview({
      target: locationsPanel,
      mapview,
    });

    // Begin highlight interaction.
    mapview.interactions.highlight();

    // Select locations from hooks.
    mapp.hooks.current.locations.forEach((_hook) => {
      // Split location hook into layer key and id.
      const hook = _hook.split('!');

      // Get the location.
      // Will be added to listview in location panel.
      mapp.location.get({
        layer: mapview.layers[decodeURIComponent(hook[0])],
        id: hook[1],
      });
    });

    // Configure idle mask if set in locale.
    mapp.user &&
      mapview.locale.idle &&
      mapp.ui.utils.idleLogout({
        host: mapp.host,
        idle: mapview.locale.idle,
      });
  </script>
  </body>
</html>
