<!DOCTYPE html>
<html lang="{{language}}">

<head data-dir="{{dir}}" data-login="{{login}}">

    <title>{{title}}</title>

    <link rel="icon" type="image/x-icon" href="{{dir}}/public/icons/favicon.ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

    <script src="https://cdn.jsdelivr.net/npm/ol@v10.2.1/dist/ol.js" defer></script>

    <!-- Load XYZ / MAPP stylesheet and library. -->
    <link rel="stylesheet" href="{{dir}}/public/css/mapp.css" />
    <link rel="stylesheet" href="{{dir}}/public/css/ui.css" />
    <link rel="stylesheet" href="{{dir}}/public/css/views/test.css" />

    <script type="importmap">
        {
          "imports": {
            "codi": "https://esm.sh/codi-test-framework@0.0.47"
          }
        } </script>

    <script type="module" src="{{dir}}/public/js/lib/mapp.js" defer></script>
    <script type="module" src="{{dir}}/public/js/lib/ui.js" defer></script>
    <script type="module" src="{{dir}}/public/js/tests/_mapp.test.js" defer></script>

</head>

<body style="grid-template-rows: auto 0 0;">

    <div id="Map">

        <div id="OL"></div>

    </div>

    <div id="mapButton" class="btn-column"></div>

    <div id="tabview-divider"></div>

    <div id="Tabview" class="tabview mobile-display-none desktop-display-none"></div>

    <div id="ctrls-divider"></div>

    <div id="ctrls" class="lighter-background">

        <div id="ctrl-tabs" class="hover">
            <div data-id="layers" class="mask-icon layers active"></div>
            <div data-id="locations" class="mask-icon locations"></div>
        </div>

        <div id="ctrl-panel">
            <div id="layers" class="active"></div>
            <div id="locations"></div>
        </div>

    </div>

    <script type="module">

        import * as _codi from "codi";

        self.codi = _codi;

        const urlParams = new URLSearchParams(window.location.search);
        const integrity = urlParams.get('integrity');
        const testFiles = integrity ? [`${window.location.origin}{{dir}}/public/tests/integrity.test.mjs`] : [`${window.location.origin}{{dir}}/tests/browser/local.test.mjs`];

        try {

            // Set mapp.language to TEST 
            mapp.user ??= {};

            mapp.user.language = 'TEST';
            mapp.language = 'TEST';

            // Language as URL parameter will override user language.
            if (mapp.hooks.current.language) {

                mapp.language = mapp.hooks.current.language

            } else if (mapp?.user?.language) {

                if (!Object.hasOwn(mapp.dictionaries, mapp.user.language)) {

                    // Set mapp.language to english if user.language is not supported by mapp.dictionaries.
                    console.warn(`'${mapp.user.language}' mapp.language is not supported by mapp.dictionaries.`)
                    mapp.language = 'en'
                } else {

                    mapp.language = mapp.user.language
                }
            }

            let results = {};

            if (integrity) {
                results = await codi.runWebTests(testFiles);
            } else {
                results = await codi.runWebTestFunction(_mappTest.coreTest);
            }

            const shouldDownload = urlParams.get('download') === 'true';

            if (shouldDownload) {
                const jsonString = JSON.stringify(results, null, 2);

                const blob = new Blob([jsonString], { type: 'application/json' });

                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${window.location.origin}{{dir}}-${Date.now()}.json`;

                document.body.appendChild(link);

                link.click();

                document.body.removeChild(link);

                URL.revokeObjectURL(url);
            }


        } catch (error) {
            console.error('Error running tests:', error);
        }
    </script>

</body>

</html>