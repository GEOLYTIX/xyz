<!doctype html>
<html lang="{{language}}">
  <head data-dir="{{dir}}" data-login="{{login}}">
    <title>{{title}}</title>

    <link
      rel="icon"
      type="image/x-icon"
      href="{{dir}}/public/icons/favicon.ico"
    />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />

    <script
      src="https://cdn.jsdelivr.net/npm/ol@v10.3.1/dist/ol.js"
      integrity="sha384-GtOM9G1JWFKmDbfOLBrez9YebIrX1pqVVtYukhqrKOtyneLNxnTIFMe8ER850GT/"
      crossOrigin="anonymous"
      defer
    ></script>

    <!-- Load XYZ / MAPP stylesheet and library. -->
    <link rel="stylesheet" href="{{dir}}/public/css/mapp.css" />
    <link rel="stylesheet" href="{{dir}}/public/css/ui.css" />

    <script type="importmap">
      {
        "imports": {
          "codi": "https://esm.sh/codi-test-framework@0.0.47"
        }
      }
    </script>

    <script type="module" src="{{dir}}/public/js/lib/mapp.js" defer></script>
    <script type="module" src="{{dir}}/public/js/lib/ui.js" defer></script>
    <script
      type="module"
      src="{{dir}}/public/js/tests/_mapp.test.js"
      defer
    ></script>

    <style>
      html {
        position: fixed;
        bottom: 0%;
        top: 0%;
        height: 100%;
        width: 100%;
      }
  
      #Map {
        position: relative;
      }
  
      #Map .ol-scale-line {
        right: 5px;
        top: 5px;
        position: fixed;
      }
  
      #ctrls {
        z-index: 9999;
      }
  
      #ctrl-tabs {
        padding: 0.5em;
        width: 100%;
        display: flex;
      }
  
      #ctrl-tabs>div {
        flex-grow: 1;
        font-size: 2em;
      }
  
      #ctrl-panel {
        overflow-y: auto;
      }
  
      #ctrl-panel>div {
        display: none;
        padding: 10px;
      }
  
      #ctrl-panel>div.active {
        display: block;
      }
  
      .bg-icon.mapp {
        background-image: url("https://geolytix.github.io/public/mapp_v4/emblem.svg");
      }
  
      @media only screen and (min-width: 768px) {
  
        body {
          display: grid;
          grid-template-columns: 350px 10px auto;
        }
  
        body.fullscreen {
          grid-template-columns: 0 0 auto !important;
        }
  
        body.fullscreen #ctrls {
          display: none;
        }
  
        #Map {
          grid-row: 1;
          grid-column: 3;
          position: relative;
        }
  
        #OL {
          width: 100%;
          height: 100vh;
          position: absolute;
        }
  
        .map-attribution {
          padding-left: 4em;
        }
  
        
  
        #ctrl-panel {
          transform: rotateY(180deg);
        }
  
        #ctrl-panel>div {
          transform: rotateY(180deg);
        }
  
        #ctrls {
          grid-row: 1/4;
          grid-column: 1;
          height: 100%;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }
  
        #Tabview {
          grid-row: 3;
          grid-column: 3;
        }
  
      }
  
      @media only screen and (max-width: 768px) {
  
        html {
          overflow: scroll;
        }
  
        body {
          overflow-y: scroll;
          overflow-x: hidden;
        }
  
        #Map {
          height: calc(100% - 50px);
          width: 100%;
        }
  
        #OL {
          width: 100%;
          height: 100%;
        }
  
        #ctrls {
          width: 100%;
          height: 100%;
          position: relative;
        }
  
      }
    </style>
  </head>

  <body style="grid-template-rows: auto 0 0">
    <div id="Map"></div>
  
      <div id="OL"></div>
  
    </div>
  
    <div id="mapButton" class="btn-column"></div>
  
    <div id="tabview-divider"></div>
  
    <div id="Tabview" class="tabview mobile-display-none desktop-display-none"></div>
  
    <div id="ctrls-divider"></div>
  
    <div id="ctrls" class="lighter-background">
  
      <div id="ctrl-tabs" class="hover">
        <div data-id="layers" class="active material-symbols-outlined">
          
            layers
  
        </div>
        <div data-id="locations" class="material-symbols-outlined">
          location_on
        </div>
  
      </div>
  
      <div id="ctrl-panel">
        <div id="layers" class="active"></div>
        <div id="locations"></div>
      </div>
  
    </div>

    <script type="module">
      import * as _codi from 'codi';

      self.codi = _codi;

      const urlParams = new URLSearchParams(window.location.search);
      const integrity = urlParams.get('integrity');
      const testFiles = integrity
        ? [`${window.location.origin}{{dir}}/public/tests/integrity.test.mjs`]
        : [`${window.location.origin}{{dir}}/tests/browser/local.test.mjs`];

      try {
        // Set mapp.language to TEST
        mapp.user ??= {};

        mapp.user.language = 'TEST';
        mapp.language = 'TEST';

        // Language as URL parameter will override user language.
        if (mapp.hooks.current.language) {
          mapp.language = mapp.hooks.current.language;
        } else if (mapp?.user?.language) {
          if (!Object.hasOwn(mapp.dictionaries, mapp.user.language)) {
            // Set mapp.language to english if user.language is not supported by mapp.dictionaries.
            console.warn(
              `'${mapp.user.language}' mapp.language is not supported by mapp.dictionaries.`,
            );
            mapp.language = 'en';
          } else {
            mapp.language = mapp.user.language;
          }
        }

        let results = {};

        if (integrity) {
          results = await codi.runWebTests(testFiles);
        } else {
          results = await codi.runWebTestFunction(_mappTest.coreTest);
        }

        const shouldDownload = urlParams.get('download') === 'true';

        if (shouldDownload) {
          const jsonString = JSON.stringify(results, null, 2);

          const blob = new Blob([jsonString], { type: 'application/json' });

          const url = URL.createObjectURL(blob);

          const link = document.createElement('a');
          link.href = url;
          link.download = `${window.location.origin}{{dir}}-${Date.now()}.json`;

          document.body.appendChild(link);

          link.click();

          document.body.removeChild(link);

          URL.revokeObjectURL(url);
        }
      } catch (error) {
        console.error('Error running tests:', error);
      }
    </script>
  </body>
</html>
