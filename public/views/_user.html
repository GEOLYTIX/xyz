<!DOCTYPE html>
<html>

<head data-user="{{user}}" data-dir="{{dir}}">
  <title>XYZ | User Administration</title>
  <link rel="icon" type="image/x-icon" href="{{dir}}/public/icons/favicon.ico" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://unpkg.com/tabulator-tables@6.2.0/dist/css/tabulator.min.css" rel="stylesheet">

  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.0/dist/js/tabulator.min.js"></script>

  <script type="module" src="{{dir}}/public/js/lib/mapp.js" defer></script>
  <script type="module" src="{{dir}}/public/js/lib/ui.js" defer></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,600;1,200;1,300&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      border-spacing: 0;
      font-family: 'Titillium Web', sans-serif;
      color: #3f3f3f;
    }

    body {
      position: absolute;
      height: 100%;
      width: 100%;
      padding: 2em;
      font-size: 0.8em;
    }

    body>.flex {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    a {
      text-decoration: none;
      font-weight: bold;
      color: #003D57;
    }

    /* begin agaTable styling */

    #userTable {
      height: 100%;
      width: 100%;
      overflow-y: scroll;
      overflow-x: hidden;
    }

    table {
      position: relative;
      width: 100%;
      border: 1px solid #00000033;
      border-radius: 3px; 
      background-color: white;
      padding: 0 0.25em;
      display: table;
      overflow: scroll;
      cursor: pointer;
    }

    table tr {
      border-bottom: 1px solid #00000011; 
    }

    table tr:hover {
      background-color: #fffde7;
    }

    table tr td {
      border-bottom: 1px solid #00000011; 
      padding: 0.2em;
      text-overflow: ellipsis;
    }

    table thead {
      text-align: left;
      font-weight: bold; 
      border-bottom: 1px solid #00000011;
    }

    table thead th {
      position: sticky;
      top: 0;
      background-color: white;
      box-shadow: 0 1px 2px -1px rgba(0, 0, 0, 0.4);
    }

    td .dot {
      margin-right: 2px;
      height: 0.8em;
      width: 0.8em;
      border-radius: 50%;
      display: inline-block;
    }

    /* end agaTable styling */

    /* begin form style */
    .mask {
      position: fixed; 
      top:0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      background-color: #00000033; 
      z-index: 10000;
    }

    .none {
      display: none;
    }

    .form {
      position: sticky; 
      z-index: 10001; 
      border-radius: 3px; 
      margin: 1em auto;
      max-height: 100%; 
      overflow: auto; 
      background-color: #ffffff;
      box-shadow: rgba(0, 0, 0, 0.15) 1.95px 1.95px 2.6px;
    }

    .form *:focus {
      outline: none;
    }

    .form fieldset {
     border: none;
    }
   
    .form form {
      padding: 10px;
    }

    .form form ul {
      list-style-type: none;
    }
    
    .form form li {
      padding: 0.3em;
    }

    input[type="email"], input[type="text"], input[type="number"], input[type="date"], input[type="search"] {
      width: 100%;
      outline: none;
      border: solid 1px #ccccccee;
      border-radius: 2px;
      padding: 0.2em;
    }

    .form input[type="reset"] {
      background: none;
      outline: none;
      border: none;
      color: inherit;
    }

    .form select {
      width: 100%;
      border: solid 1px #ccccccee;
      border-radius: 2px;
    }

    .account-blocked {
      color: #546e7a;
      background: #cfd8dc;
    }

    input[type="checkbox"] {
      vertical-align: middle;
      accent-color: #003D57;
    }

    input:focus {
      outline: none;
    }

    /* end form style */

    /* begin pill style */
    .pill-container {
      display: flex;
      gap: 4px;
      flex-flow: row wrap;
      padding: 0.5em 0;
    }
    
    .pill-container .pill {
      cursor: default;
      padding: 1px 1px 1px 2px;
      border-radius: 2px;
      font-size: 0.9em;
      font-weight: bold;
      color: #f2f2f2;
      background-color: #003D57;
      user-select: none;
    }
    
    .pill-container .pill button {
      cursor: pointer;
      font-size: 0.8em;
      padding: 0 2px;
    }

    .searchbox {
      position: relative;
    }

    .searchbox ul {
      position: absolute;
      width: 100%;
    }
    
    .li-role {
      border-bottom: solid 1px #ccc;
      cursor: pointer;
      background-color: white;
      width: 100%;
    }

    .li-role:hover {
      background-color: #fffde7;
    }
    
    /* end pill style */

    .btn-row {
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      display: flex;
      gap: 10px;
      margin: 1em 0;
    }

    button {
      border: none;
      outline: none;
      background: none;
      text-align: center;
      color: white;

      &:hover {
        cursor: pointer;
      }

      &.raised {
        border-radius: 3px;
        border: 1px solid #f2f2f2;
        box-shadow: 1px 1px 2px #f2f2f2;
        padding: 0.3em;
      }

      &.primary-colour {
        background-color: #003D57;
      }

      &.red {
        background-color: #f44336;
      }
    }

    @media only screen and (min-width: 768px) {
      #userTable {
        width: 70%;
        margin: auto;
      }
      .form {
        width: 400px;
      }

      .btn-row {
        width: 70%;
        margin: 1em auto;
      }
    }

    @media only screen and (max-width: 700px) {

      body,
      h1 {
        margin: 0
      }

      .form {
        width: 95%;
      }
    }
  </style>

</head>

<body>

  <div class="mask none"></div>

  <div class="flex">
    
    <div><img src="https://geolytix.github.io/public/geolytix_mapp.svg" height="10"></div>
    <h1>Account Administration</h1>

    <p>Logged in as <span id="logged-in"></span></p>

    <div class="btn-row">
      
      <div>
        <button class="raised primary-colour" id="default-view"
          onclick="window.location.href = `${window.location.origin}{{dir}}`">&#8592;&nbsp;Back to Mapp</button>
        <button class="raised primary-colour" id="test-view"
          onclick="window.location.href = `${window.location.origin}{{dir}}?template=test_view&download=true`">Test View</button>
        <button class="raised red" id="logout" onclick="window.location.href = `${window.location.origin}{{dir}}?logout=true`">Logout</button>
      </div>

    </div>

    <div class="btn-row">

      <input type="text" id="filterInput" placeholder="Search accounts">

        <label for="showBlocked">
          <input id="showBlocked" type="checkbox" style="margin-right: 4px;">Show blocked accounts</label>
      
    </div>

    <div id="userTable"></div>

  </div>

</body>


<script>
  window.onload = async () => {

    if (!document.head.dataset.user) {
      window.location.href = '?login=true'
      return;
    }

    // Get list of available roles from workspace.
    const rolesList = await xhrPromise(`${document.head.dataset.dir}/api/workspace/roles`)

    // List of languages key values. 
    const languagesList = {
      "en": "English",
      "de": "German",
      "zh": "Chinese",
      "zh_tw": "Chinese (Traditional)",
      "pl": "Polish",
      "ja": "Japanese",
      "es": "Spanish",
      "fr": "French",
      "tr": "Turkish",
      "it": "Italian",
      "th": "Thai",
    };

    const params = {}

    // Get URL params.
    window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, (match, key, value) => {
      params[key] = decodeURI(value)
    })

    const cookie = await fetch(`${document.head.dataset.dir}/api/user/cookie`)

    document.getElementById('logged-in').textContent = cookie.email || 'Unknown';

    document.querySelector('.mask').addEventListener('click', e => {
      let form = document.querySelector('.form');
      if(form && form.contains(e.target)) return;
      document.querySelector('.mask').classList.add('none');
    })

    function clearNode(node) {
      if(!node) return;
      while(node.firstChild) {
        node.removeChild(node.firstChild)
      }
    }

    // function to compare if 2 ets have the same elements
    const eqSet = (xs, ys) => xs.size === ys.size && [...xs].every((x) => ys.has(x));

    function checkUserStatus(user) {
      let state = {label: 'New', color: '#e91e63'};
      if(user.verified) state = {label: 'Verified', color: '#ff5722'}
      if(user.approved) state = {label: 'Approved', color: '#43a047'}
      if(user.blocked) state = {label: 'Blocked', color: '#263238'}
      let bg = `background-color: ${state.color}`;
      return mapp.utils.html.node`<span class="dot" style=${bg}></span>${state.label}`
    }

    function submit(user) {
      
      fetch(`${document.head.dataset.dir}/api/user/put`, {
        method: "POST",
        body: JSON.stringify(user),
        headers: {
          "Content-type": "application/json"
        }
      })
      .then(response => {
        document.querySelector('.mask').classList.add('none');
        createUserTable();
        setTimeout(() => (alert('Changes have been saved.')), 500);
      });

    }

    function userForm(user) {
      
      console.log(user);

      const form = mapp.utils.html.node`<form
      onreset=${e => {
        e.preventDefault();
        document.querySelector('.mask').classList.add('none');
      }}
      onchange=${e => {
        e.preventDefault();
      }}
      onsubmit=${e => {
        e.preventDefault();
        const formData = new FormData(form);

        // will store updated user settings
        const userUpdated = {};

        Object.entries(user).forEach(i => {

          let updated = [...formData].find(j => j[0] === i[0]);

          // skip unchanged fields
          if(updated === undefined) return;
          // skip checked options if no change
          if(updated[1] === 'on' && i[1]) return;
          // skip unchecked options if no change
          if(updated[1] === 'no' && !i[1]) return;
          // check if roles have been edited
          if(updated[0] === 'roles') {
            let initial_roles = new Set(user.roles);
            let new_roles = new Set(updated[1].split(","));
            // check if roles have been altered
            let rolesUnchanged = eqSet(initial_roles, new_roles);
            if(rolesUnchanged) return;
            userUpdated.roles = `{${updated[1]}}`
            return;
          }
          // process expiry date if it was changed
          if(updated[0] === 'expires_on') {
            if(!updated[1]) return;
            const prevExpiryDate = (new Date(user.expires_on*1000)).toLocaleDateString('fr-CA');
            if(prevExpiryDate === updated[1]) return;
            userUpdated[i[0]] = parseInt(new Date(updated[1]).getTime() / 1000);
            return;
          }
          // set changes on user updated payload
          switch(updated[1]) {
            case 'on':
              userUpdated[i[0]] = true; // flags on 
              break;
            case 'no': 
              userUpdated[i[0]] = false; // flags off
              break;
            default:
            userUpdated[i[0]] = updated[1]; // new value
          }
        });

        userUpdated.email = user.email;
        //return console.log(userUpdated);
        submit(userUpdated);

      }}>
      <div><h2>Account Details</h2></div>
      <ul>
        <li>
        <fieldset title="Account e-mail address">
          <label for="email">email</label>
          <input type="email" id="email" name="email" required value=${user.email} disabled>
        </fieldset>  
        </li>
        <li>
          <fieldset title="Account Language">
            <label for="language">Language</label>
            <select name="language" id="language">
              ${Object.entries(languagesList).map(l => {
                if(l[0] === user.language) return mapp.utils.html.node`<option selected value=${l[0]}>${l[1]}`
                return mapp.utils.html.node`<option value=${l[0]}>${l[1]}`
              })}
            </select>
          </fieldset>  
        </li>
        </ul>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); grid-gap: 0.5em; padding: 0.2em;">
          <div style="grid-column: 1 / span 3;">User Status</div>

          <fieldset title="The account email has been verified through a token sent to the email address">
            ${() => {
              let chk = mapp.utils.html.node`<input type="checkbox" id="verified" name="verified">`;
              chk.checked = user.verified;
              return chk;
            }}
            <label for="verified"><b>Verified</b></label>
            <input type="hidden" name="verified" value="no"/>
          </fieldset>  


          <fieldset title="The account has an outstanding password reset to be verified">
            ${() => {
              let chk = mapp.utils.html.node`<input type="checkbox" id="re_verification" name="re_verification">`;
              chk.checked = user.re_verification;
              return chk;
            }}
            <label for="re_verification"><b>Re-verification</b></label>
            <input type="hidden" name="re_verification" value="no"/>
          </fieldset>  


          <fieldset title="The account has been approved by a site administrator and is permitted to access the application">
            ${() => {
              let chk = mapp.utils.html.node`<input type="checkbox" id="approved" name="approved">`;
              chk.checked = user.approved;
              return chk;
            }}
            <label for="approved"><b>Approved</b></label>
            <input type="hidden" name="approved" value="no"/>
          </fieldset>  


          <fieldset title="The account is an admin account which can access this page and change other account credentials">
            ${() => {
              let chk = mapp.utils.html.node`<input type="checkbox" id="admin" name="admin">`;
              chk.checked = user.admin;
              return chk;
            }}
            <label for="admin">Administrator</label>
            <input type="hidden" name="admin" value="no"/>
          </fieldset>  


          <fieldset title="The account has priviliges to create API keys">
            ${() => {
              let chk = mapp.utils.html.node`<input type="checkbox" id="api" name="api">`;
              chk.checked = user.api;
              return chk;
            }}
            <label for="api">API</label>
            <input type="hidden" name="api" value="no"/>
          </fieldset>  

          <fieldset title="Blocked accounts can no longer login or reset their password">
            ${() => {
              let chk = mapp.utils.html.node`<input 
              type="checkbox" id="blocked" name="blocked">`;
              chk.checked = user.blocked;
              return chk;
            }}
            <label for="blocked"><b><span style="color: #f44336;">Blocked</span></b></label>
            <input type="hidden" name="blocked" value="no"/>
          </fieldset>  

        </div>

        <div style="padding: 0.2em">
          <div>Access Roles</div>
          ${
            (() => {

              if(!rolesList.length) return mapp.utils.html.node`
              <input type="text" disabled value="No access roles defined">`;

              const rolesContainer = mapp.utils.html.node`<div>`

              const pills = mapp.ui.elements.pills({
                target: rolesContainer,
                pills: user.roles,
                addCallback: (val, pills) => {
                  let roles_input_el = document.querySelector('.form input[type="hidden"][name="roles"]');
                  if(!roles_input_el) return;
                  roles_input.value = [...pills].join(',');

                  // reset searchbox and results
                  searchbox.list.innerHTML = '';
                  searchbox.input.value = '';
                },
                removeCallback: (val, pills) => {
                  roles_input.value = [...pills].join(',');

                }
              })

              const roles_input = mapp.utils.html.node`<input type="hidden" name="roles"/>`;

              const searchbox = mapp.ui.elements.searchbox({
                target: rolesContainer,
                placeholder: 'Search access roles',
                searchFunction: (e) => {
                  
                  searchbox.list.innerHTML = '';
                  
                  if(!e.target.value) return;
                  
                  const pattern = e.target.value;
                  
                  let filtered = rolesList.filter(val =>
                  val.toLowerCase().startsWith(pattern.toLowerCase()))
                  
                  if (!filtered.length) {
                    
                    searchbox.list.append(mapp.utils.html.node`
                    <li class="li-role"
                    onclick=${e => {
                      e.stopPropagation();
                      searchbox.list.innerHTML = '';
                      searchbox.input.value = '';
                    }}
                    ><span>${mapp.dictionary.no_results}`);
                      
                    return;
                  }
                  
                  filtered
                  .filter(val => !pills.pills.has(val))
                  .filter((val, i) => i < 9)
                  .forEach(val => {
                    
                    searchbox.list.append(mapp.utils.html.node`<li class="li-role" onclick=${e => {
                      e.stopPropagation();
                      if(pills.pills.has(val)) return;
                      pills.add(val);
                      roles_input.value = [...pills.pills].join(',')
                    }}>${val}`)
                  });
                }
              })

              rolesContainer.appendChild(roles_input)

              return rolesContainer;

            })()
          }
        </div>

        <ul>
        <li>
          <fieldset title="Administrator who approved last modification to this account">
            <label for="approved_by">Approved by</label>
            <input type="text" id="approved_by" name="approved_by" disabled value=${user.approved_by}>
          </fieldset>  
        </li>
        <li>
          <fieldset title="Date when user access expires">
            <label for="expires_on">Account expires on</label>
            <input type="date" id="expires_on" name="expires_on"
            value=${((e) => {
              if(!user.expires_on) return;
              const expiryDate = new Date(user.expires_on*1000);
              return expiryDate.toLocaleDateString('fr-CA')
            })()}>
          </fieldset>  
        </li>
        <li>
          <fieldset title="User Access History">
            <label for="access_log">Access Log</label>
            <input type="text" id="access_log" name="access_log" disabled value=${user.access_log}>
          </fieldset>  
        </li>
        <li>
          <fieldset>
            <label for="verificationtoken">Verification Token</label>
            <input type="text" id="verificationtoken" name="verificationtoken" disabled value=${user.verificationtoken}>
          </fieldset>  
        </li>
        <li>
          <fieldset title="Failed Login Attempts">
            <label for="failedattempts">Failed Login Attempts</label>
            <input type="number" id="failedattempts" name="failedattempts" disabled value=${user.failedattempts}>
          </fieldset>  
        </li>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); padding: 0.5em;">
          <button class="raised primary-colour">Save</button>
          <button class="raised primary-colour">
            <input type="reset" value="Cancel"/>
          </button>
          <button class="raised red"
          onclick=${async e => {
            e.preventDefault();

            if(!confirm(`Are you sure to delete ${user.email} account?`)) return;
            
            const response = await xhrPromise(`${document.head.dataset.dir}/api/user/delete?email=${user.email}`);
            document.querySelector('.mask').classList.add('none');
            if (response.err) return console.error(response.err);
            document.querySelector(`#userTable table tr[data-email='${user.email}']`).remove();

            setTimeout(() => (alert(`Account for ${user.email} has been permanently deleted.`)), 400)

          }}>Delete User
          </button>
        `;

        return form;
    }
  

    async function createUserTable() {

      const userList = await getUserList();

      let el = document.getElementById('userTable');
      clearNode(el);

      const table = mapp.utils.html.node`<table>
      <thead>
        <tr>
          <th>email</th>
          <th>Status`;

        const tbody = mapp.utils.html.node`<tbody>`

        Object.values(userList).map(i => {

          let bg = i.email === params.email ? `background-color: #fff9c4; font-weight: bold` : ``;

          tbody.appendChild(mapp.utils.html.node`<tr 
          class="${i.blocked ? `account-blocked none`: ``}"
          style=${bg}
          data-email=${i.email}
          onclick=${e => {
            e.stopPropagation();
            let mask = document.querySelector('.mask');
            clearNode(mask);
            mask.classList.remove('none');
            const div = mapp.utils.html.node`<div class="form">`
            const form = userForm(i);
            div.appendChild(form);
            mask.appendChild(div);
          }}>
          <td>${i.email}</td>
          <td>${checkUserStatus(i)}</td>
          </tr>`)
        });

        table.appendChild(tbody);

        el.appendChild(table);

    }

    async function getUserList(){
      
      // Get user list from host.
      const response = await xhrPromise(`${document.head.dataset.dir}/api/user/list`)
      
      // Data must be an array if only 1 record returned in response.
      const data = Array.isArray(response) && response || [response]
      
      data.forEach(row => {
        row.re_verification = !row.verificationtoken
      })
      
      // Sort data to promote email from url parameter to top.
      if (params.email) {
        data.sort(function (x, y) { return x.email == params.email ? -1 : y.email == params.email ? 1 : 0; });
      }

      return data;
    
    }


    await createUserTable();

    function xhrPromise(req){
      
      return new Promise((resolve, reject) => {

      const xhr = new XMLHttpRequest()

        xhr.open('GET', req)
        //xhr.open('POST', req)
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.responseType = 'json'

        xhr.onload = e => {
          if (e.target.status >= 300) return reject({ err: e.target.status })
          resolve(e.target.response || {})
        }

        xhr.send()
      })
    }
    
    // email address search
    document.getElementById("filterInput").addEventListener('input', e => {
      let table = document.querySelector('#userTable table');
      let filter = e.target.value.toLowerCase();
      let trs = table.querySelectorAll("tr");

      for(let tr of trs) {
        let td = tr.querySelector("td");
        if(!td) continue;
        tr.style.display = td.textContent.toLowerCase().indexOf(filter) > -1 ? "" : "none";
      }
    })

    document.getElementById("showBlocked").addEventListener('click', e => {

      let blocked = e.target.checked;

      if (blocked) {
        Array.from(document.querySelectorAll('#userTable table tr.account-blocked')
        ).map(el => el.classList.remove('none'));
        //createUserTable();
        return;
      }

      Array.from(document.querySelectorAll('#userTable table tr.account-blocked'))
      .map(el => el.classList.add('none'));
    })

    return;
    // the code below is just a reference from the previous design 

    async function getAccessLog(e, cell) {

      const user = cell.getData();

      const response = await xhrPromise(`${document.head.dataset.dir}/api/user/log?email=${user.email}`);

      if (response.err) return console.error(response.err);

      alert(response.access_log.join('\n'));
    };

    function rolesEdited(e) {

      if (JSON.stringify(e._cell.value) === JSON.stringify(e._cell.oldValue)) return;

      xhrPromise(`${document.head.dataset.dir}/api/user/update?email=${e._cell.row.data.email}&field=roles&value=${encodeURIComponent(e._cell.value)}`)
    }
  } 

</script>

</html>