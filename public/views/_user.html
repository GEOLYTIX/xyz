<!DOCTYPE html>
<html>

<head data-user="{{user}}" data-dir="{{dir}}">
  <title>XYZ | User Administration</title>
  <link rel="icon" type="image/x-icon" href="{{dir}}/icons/favicon.ico" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">

  <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>

  <script src="https://unpkg.com/uhtml" defer></script>

  <style>
    body {
      margin: 40px;
      padding: 0;
      font: 14px "Open Sans", sans-serif;
    }

    .tabulator-row .tabulator-cell {
      margin: 2px;
    }

    .tabulator .tabulator-header .tabulator-col {
      margin: 2px;
      padding-bottom: 10px;
    }

    .icon-face {
      background-image: url("{{dir}}/icons/icon-face.svg");
    }

    .icon-logout {
      background-image: url("{{dir}}/icons/icon-logout.svg");
    }

    .icon-tick-done {
      background-image: url("{{dir}}/icons/icon-tick-done.svg");
    }

    .icon-tick-done-all {
      background-image: url("{{dir}}/icons/icon-tick-done-all.svg");
    }

    .icon-warning {
      background-image: url("{{dir}}/icons/icon-warning.svg");
    }

    .icon-translate {
      background-image: url("{{dir}}/icons/icon-translate.svg");
    }

    .icon-supervisor-account {
      background-image: url("{{dir}}/icons/icon-supervisor-account.svg");
    }

    .icon-settings {
      background-image: url("{{dir}}/icons/icon-settings.svg");
    }

    .icon-key {
      background-image: url("{{dir}}/icons/icon-key.svg");
    }

    .icon-lock-closed {
      background-image: url("{{dir}}/icons/icon-lock-closed.svg");
      height: 40px;
      width: 30px;
    }

    .xyz-icon {
      background-repeat: no-repeat;
      background-position: center;
      height: 36px;
      width: 36px;
    }

    @media only screen and (max-width: 700px) {

      body,
      h1 {
        margin: 0
      }
    }

    #dropdown {
      margin: 10px auto;
      width: 50%;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      border-spacing: 0;
    }

    button {
      border: none;
      outline: none;
      background: none;
    }

    button:hover:enabled {
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.3;
    }

    .btn-drop {
      position: relative;
      width: 100%;
      background-color: white;
      box-shadow: 1px 1px 3px 0 #ddd;
    }

    .btn-drop:disabled {
      pointer-events: none;
      opacity: 0.4;
    }

    .btn-drop>.head {
      padding: 5px;
      display: flex;
      border: 1px solid #ccc;
      align-items: center;
    }

    .btn-drop>.head> :first-child {
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .btn-drop>.head>.icon {
      pointer-events: none;
      margin-left: auto;
      width: 18px;
      content: url("https://fonts.gstatic.com/s/i/materialicons/expand_more/v1/24px.svg");
    }

    .btn-drop>ul {
      display: none;
      position: absolute;
      list-style-type: none;
      width: inherit;
      box-shadow: 1px 1px 3px 0 #ddd;
      max-height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid #ccc;
      border-top: none;
      text-align: left;
      background-color: white;
      z-index: 1;
    }

    .btn-drop>ul>li {
      padding: 5px;
    }

    .btn-drop>ul>li:hover {
      background-color: #eee;
    }

    .btn-drop>ul>li.selected {
      background-color: #ccc;
    }

    .btn-drop.active>.head {
      border-bottom: 1px solid #eee;
    }

    .btn-drop.active>ul {
      display: block;
      margin-top: -2px;
    }

    .btn-drop.active>.head>.icon {
      content: url("https://fonts.gstatic.com/s/i/materialicons/expand_less/v1/24px.svg");
    }
  </style>

</head>

<body>

  <h1>Account admin | <a style="color:#B71C1C" href="?logout=true">Logout</a></h1>

  <div id="userTable"></div>

</body>

<script>
  window.onload = async () => {

    const rolesList = await xhrPromise(`${document.head.dataset.dir}/api/workspace/roles`)

    const params = {}

    window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, (match, key, value) => {
      params[key] = decodeURI(value)
    })

    const response = await xhrPromise(`${document.head.dataset.dir}/api/user/list`)

    const data = response.length && response || [response]

    if (params.email) {
      data.sort(function (x, y) { return x.email == params.email ? -1 : y.email == params.email ? 1 : 0; });
    }

    new Tabulator(document.getElementById('userTable'),
      {
        rowFormatter: row => {

          const user = row.getData()

          row.getElement().style.backgroundColor = user.email === params.email && '#fff9c4'

          row.getElement().style.backgroundColor = user.blocked && '#ef9a9a'

        },
        columns: [
          {
            field: 'email',
            headerTooltip: 'Account EMail',
            titleFormatter: () => '<div class="icon-face xyz-icon"></div>',
          },
          {
            field: 'verified',
            align: 'center',
            headerTooltip: 'The account email has been verified through a token sent to the email address.',
            titleFormatter: () => '<div class="icon-tick-done xyz-icon"></div>',
            formatter: 'tickCross',
            cellClick: cellToggle,
          },
          {
            field: 'approved',
            align: 'center',
            headerTooltip: 'The account has been approved by a site administrator and is permitted to access the application.',
            titleFormatter: () => '<div class="icon-tick-done-all xyz-icon"></div>',
            formatter: 'tickCross',
            cellClick: cellToggle,
          },
          {
            field: 'admin',
            align: 'center',
            headerTooltip: 'The account is an admin account which can access this page and change other account credentials.',
            titleFormatter: () => '<div class="xyz-icon icon-supervisor-account"></div>',
            formatter: 'tickCross',
            cellClick: cellToggle,
          },
          {
            field: 'api',
            align: 'center',
            headerTooltip: 'The account has priviliges to create API keys.',
            titleFormatter: () => '<div class="xyz-icon icon-key"></div>',
            formatter: 'tickCross',
            cellClick: cellToggle,
          },
          {
            field: 'failedattempts',
            align: 'center',
            headerTooltip: 'Failed login attempts.',
            titleFormatter: () => '<div class="xyz-icon icon-warning"></div>',
            formatter: (cell, formatterParams) => '<span style="color:red; font-weight:bold;">' + cell.getValue() + '</span>',
          },
          {
            field: 'language',
            align: 'center',
            headerTooltip: 'Account language',
            titleFormatter: () => '<div class="xyz-icon icon-translate"></div>',
          },
          {
            field: 'roles',
            title: 'Roles',
            headerTooltip: 'Account roles',
            headerSort: false,
            editor: roleEdit,
          },
          {
            field: 'access_log',
            title: 'Access Log',
            headerTooltip: 'Click last access log entry for full access log array.',
            cellClick: getAccessLog,
          },
          {
            field: 'approved_by',
            title: 'Approved by',
            headerTooltip: 'Admin who approved last modification to this account.',
          },
          {
            field: 'expires_in',
            title: 'Expires in Days',
            headerTooltip: 'User approval expires in days.',
            formatter: (cell) => {
              const val = cell.getValue()
              if (val < 0) return `<span style="color:red; font-weight:bold;">${val}</span>`
              if (typeof val !== 'undefined') return `<span style="font-weight:bold;">${val}</span>`
            },
            cellClick: removeExpiry
          },
          {
            field: 'blocked',
            align: 'center',
            headerTooltip: 'Blocked accounts can no longer login or reset their password.',
            titleFormatter: () => '<div class="icon-lock-closed xyz-icon"></div>',
            formatter: 'tickCross',
            cellClick: cellToggle,
          },
          {
            field: 'delete',
            headerSort: false,
            formatter: () => '<span style="color:red; font-weight:bold;">DELETE</span>',
            cellClick: rowDelete,
          }
        ],
        resizableColumns: false,
        resizableRows: false,
        layout: 'fitDataFill',
        data: data
      });

    async function removeExpiry(e, cell) {

      const user = cell.getData();

      if (confirm('Remove expiry for ' + user.email)) {

        const response = await xhrPromise(`${document.head.dataset.dir}/api/user/update?email=${user.email}&field=approved_by&value=${document.head.dataset.user}`);

        if (response.err) return console.error(response.err);

        cell.setValue('');

        const row = cell.getRow();

        row.reformat();
      }
    };

    async function cellToggle(e, cell) {

      const user = cell.getData();

      const col = cell.getColumn();

      const response = await xhrPromise(`${document.head.dataset.dir}/api/user/update?email=${user.email}&field=${col.getField()}&value=${!cell.getValue()}`);

      if (response.err) return console.error(response.err);

      cell.setValue(!cell.getValue());

      const row = cell.getRow();

      row.reformat();
    };

    async function getAccessLog(e, cell) {

      const user = cell.getData();

      const response = await xhrPromise(`${document.head.dataset.dir}/api/user/log?email=${user.email}`);

      if (response.err) return console.error(response.err);

      alert(response.access_log.join('\n'));
    };

    async function rowDelete(e, cell) {

      const user = cell.getData();

      const row = cell.getRow();

      if (confirm('Delete account ' + user.email)) {

        const response = await xhrPromise(`${document.head.dataset.dir}/api/user/delete?email=${user.email}`);

        if (response.err) return console.error(response.err);

        row.delete();
      }
    };

    function roleEdit(cell, onRendered, success, cancel, editorParams) {

      let cellValues = cell.getValue()

      const user = cell.getData()

      const cellElement = cell.getElement()
      cellElement.style.overflow = 'visible';
      cellElement.style.border = 'none';

      // cellElement.addEventListener("blur", blur, {once: true});

      // let successTimeout;
      // function blur() {
      //   console.log('setTimeout')
      //   successTimeout = setTimeout(()=>{
      //     console.log('cancel')
      //     cancel(cellValues)
      //     cellElement.removeEventListener("blur", blur);
      //   },400)
      // }

      const editor = uhtml.html.node`
        <button
          class="btn-drop active">
            <div
              class="head"
              onclick=${(e) => {
                cellElement.style.overflow = 'hidden';
                success(cellValues)
              }}>
              <span>${cellValues}</span>
              <div class="icon"></div>
            </div>
            <ul>${rolesList.map((val) => uhtml.html`
              <li 
              class="${cellValues.some(role => role === val) && 'selected' || ''}"
              onclick=${async (e) => {
                  e.stopPropagation()

                  // clearTimeout(successTimeout)
                  // console.log('clearTimeout')
                  // cellElement.removeEventListener("blur", blur);

                  const drop = e.target.closest('.btn-drop')
                  drop.classList.toggle('active')

                  e.target.classList.toggle('selected')

                  if (e.target.classList.contains('selected')) {

                    if (cellValues[0] === '') {
                      cellValues[0] = val
                    } else {
                      cellValues.push(val)
                    }

                  } else {
                    cellValues = cellValues.filter(role => role !== val)
                  }

                  const span = drop.querySelector('span')
                  span.textContent = cellValues

                  cellElement.style.overflow = 'hidden';

                  await xhrPromise(`${document.head.dataset.dir}/api/user/update?email=${user
                    .email}&field=roles&value=${cellValues}`)

                  success(cellValues);

                }}>${val}`)}`

      return editor
    };

  }

  function xhrPromise(req) {
    return new Promise((resolve, reject) => {

      const xhr = new XMLHttpRequest()

      xhr.open('GET', req)

      xhr.setRequestHeader('Content-Type', 'application/json')

      xhr.responseType = 'json'

      xhr.onload = e => {

        if (e.target.status >= 300) return reject({ err: e.target.status })

        resolve(e.target.response || {})
      }

      xhr.send()

    })
  } 
</script>

</html>