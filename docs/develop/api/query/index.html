<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="https://geolytix.github.io/xyz/public/icons/favicon.ico">
  <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  <title>Query</title>
  <style>

    html, body {
      margin: 0;
      padding: 0;
    }

    .header-anchor {
      font-size: 80%;
    }

    .grid {
      font-family: system-ui;
      display: grid;
      grid-template-columns: min-content minmax(0, 1fr);
      max-width: 1100px;
      margin-right: auto;
      padding-right: 30px;
    }

    iframe {
      border: none;
    }

    #toggle {
        display: none;
    }

    #toggle:hover {
      cursor: pointer;
    }

    #nav {
      grid-column: 1;
      /* transform: rotateY(180deg); */
      padding: 10px 20px 20px 20px;
    }

    #nav > ul {
      /* transform: rotateY(180deg); */
      padding-inline-start: 0px;
      list-style-type: none;
      margin: 0;
    }

    #nav > ul > :first-child > a {
      padding-top: 10px;
      line-height: 1;
      font-size: 30px;
      font-weight: bold;
    }

    #content {
      grid-column: 2;
      padding-top: 6px;
      padding-left: 20px;
      border-left: 1px solid #ddd;
    }

    #content > *:first-child {
      margin: 0;
    }

    .active {
      font-weight: bold;
    }

    a {
      text-decoration: none;
      white-space: nowrap;
      color: #333;
    }

    h1, h2, h3 {
      margin-bottom: 0.5em;
    }

    p {
      margin-top: 0.5em;
      line-height: 1.5;
    }

    li {
      line-height: 1.5;
    }

    li.__0 {
      padding-left: 0;
    }

    li.__1 {
      padding-left: 0;
    }

    li.__2 {
      padding-left: 10px;
    }

    li.__3 {
      padding-left: 20px;
    }

    li.__4 {
      padding-left: 30px;
    }

    pre {
      display: block;
      font-family: monospace;
      white-space: pre;
      margin: 1em 2px;
      padding: 15px;
      box-shadow: 0 0 2px #555;
      overflow-x: auto;
      background-color: #f0f0f0;
    }

    code {
      font-family: monospace;
      background-color: #f0f0f0;
    }

    *:not(pre) > code {
      padding: 5px;
    }

    #content a {
      color: #090;
    }

    #content img {
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }

    @media only screen and (max-width: 700px) {
      .grid {
        grid-template-columns: 0 minmax(0, 1fr);
        padding: 0 0 0 40px;
      }

      #toggle {
        display: block;
        position: fixed;
        top: 10px;
        left: 10px;        
        width: 20px;
        height: 30px;
        background: repeating-linear-gradient(#ddd, #fff 10px);
      }

      #nav {
        display: none;
      }

      #content {
        border-left: none;
        padding: 0 20px 0 1px;
      }
    }

    .show_nav {
      grid-template-columns: min-content minmax(0, 1fr);
    }

    .show_nav > #nav {
      display: block;
    }

    .show_nav > #content * {
      font-size: 30%;
      padding: 0;
      overflow: hidden;
    }
  </style>

</head>

<body>

  <div class="grid">

    <div id="toggle"></div>

    <div id="nav">

      <ul>
      
        
        <li class="__1 ">
          <a href="/xyz/docs/">XYZ</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/getting-started/">Getting started</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/deploy/">Deployments</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/design/">Design</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/design/icons/">Icons</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/develop/">Develop</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/develop/api/">API</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/api/gazetteer/">Gazetteer</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/api/layer/">Layer</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/api/location/">Location</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/api/provider/">Provider</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/api/proxy/">Proxy</a>
        </li>
        
        <li class="__3 active">
          <a href="/xyz/docs/develop/api/query/">Query</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/api/user/">User</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/api/view/">View</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/api/workspace/">Workspace</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/develop/authentication/">Authentication</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/develop/filter/">SQL Filter</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/develop/lib/library/">Library</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/lib/dataviews/">Dataviews</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/lib/layers/">Layers</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/lib/locations/">Locations</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/lib/mapview/">Mapview</a>
        </li>
        
        <li class="__4 ">
          <a href="/xyz/docs/develop/lib/mapview/interactions/">Interactions</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/lib/plugins/">Plugins</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/lib/tabview/">Tabview</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/develop/lib/webpack/">Webpack</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/develop/views/">Application Views</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/document/">Document</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/environment-settings/">Environment Settings</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/logging/">Logging</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/mapp/">Mapp</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/security/">Security</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/sso/">SSO (SAML)</a>
        </li>
        
        <li class="__1 ">
          <a href="/xyz/docs/workspace/workspaces/">Workspace</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/workspace/dataviews/">Dataviews</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/dataviews/charts/">Charts</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/dataviews/tables/">Tables</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/workspace/layer/">Layer</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/layer/cluster/">Cluster</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/layer/editing/">Layer editing</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/layer/geojson/">GeoJson</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/layer/grid/">Hex Grid</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/layer/mvt/">MVT</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/layer/themes/">Themes</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/layer/tile/">Tile Layer</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/workspace/locales/">Locale</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/locales/gazetteer/">Gazetteer</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/workspace/locations/infoj/">Location</a>
        </li>
        
        <li class="__3 ">
          <a href="/xyz/docs/workspace/locations/geometry/">Geometry</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/workspace/roles/">Roles</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/workspace/src/">Source Links</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/workspace/styles/">Styles</a>
        </li>
        
        <li class="__2 ">
          <a href="/xyz/docs/workspace/templates/">Templates</a>
        </li>
        
  
      </ul>

    </div>


    <div id="content">
      <h1 id="query-api">Query API <a class="header-anchor" href="#query-api">¶</a></h1>
<p>The <a href="https://github.com/GEOLYTIX/xyz/blob/development/mod/query.js">Query API module</a> securely conveys API requests are parameterized queries to connected PostgreSQL data sources. Data source connections are configured as process environment variables to protect credentials once the API has been deployed to the cloud.</p>
<p><strong>DDL (Data Definition Language) must never be processed from a request to protect against SQL injections.</strong></p>
<p>Queries must be stored as templates in the workspace.</p>
<h2 id="template-strings">Template Strings <a class="header-anchor" href="#template-strings">¶</a></h2>
<p><a href="https://node-postgres.com/features/queries">PostgreSQL does not support parameters for identifiers.</a></p>
<p>In order to enabled substitution of any parameter the keys must defined within curly braces, prefixed by a dollar sign, eg. <code>${table}</code></p>
<p>A key in the template string will be replaced with a value from the request params object in the query string. Keys are replaced with an empty string if the key is not found in the params object.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Replace parameter for identifiers, e.g. table, schema, columns</span><br><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$\{(.*?)\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token parameter">matched</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// Remove template brackets from matched param.</span><br>  <span class="token keyword">const</span> param <span class="token operator">=</span> matched<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$|\{|\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><br><br>  <span class="token comment">// Get param value from request params object.</span><br>  <span class="token keyword">const</span> change <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">[</span>param<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">""</span><br>  <br>  <span class="token comment">// Change value may only contain a limited set of whitelisted characters.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reserved<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[A-Za-z0-9._-]*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>change<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// Err and return empty string if the change value is invalid.</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Change param no bueno"</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token string">""</span><br>  <span class="token punctuation">}</span><br>  <br>  <span class="token keyword">return</span> change<br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>PostgreSQL provides battle-tested parameter substitution code within the server itself. Placeholder in the query string ($1, $2, $n) will be substituted with parameter values which are submitted as an array with the query.</p>
<p>Values provided in the params array may be typed as objects, arrays, numeric, or text strings.</p>
<p>Parameter keys defined in curly braces prefixed with a percentage sign, eg. <code>%{id}</code> are replaced with placeholders and the value will be pushed to the params array from the request params object.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Replace params with placeholder, eg. $1, $2</span><br><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\%\{(.*?)\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token parameter">matched</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// Remove template brackets from matched param.</span><br>  <span class="token keyword">const</span> param <span class="token operator">=</span> matched<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\%|\{|\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">var</span> val <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">[</span>param<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">""</span><br><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br><br>    <span class="token comment">// Try to parse val if the string begins and ends with either [] or {}</span><br>    val <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\[\{].*[\]\}]$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">||</span> val<br><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Push value from request params object into params array.</span><br>  params<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">[</span>val<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">)</span><br>  <br>  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\$</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h3 id="parameter-parsing">Parameter parsing <a class="header-anchor" href="#parameter-parsing">¶</a></h3>
<p>In order to provide URL parameter as either array or object we check whether it is possible to parse the parameter value prior to pushing the parsed value into the SQL params array. The string must begin and end with brackets in order for the parsing to be attempted.</p>
<p><code>api/query/array_any_id?ids=[10,3]</code> will provide an array of integer to the sample query array_any_id (<code>SELECT count(1) from dev.scratch where id = ANY(%{ids})</code>).</p>
<h2 id="template-modules">Template Modules <a class="header-anchor" href="#template-modules">¶</a></h2>
<p>It is possible to generate SQL from a template module. The module's render method must return a template string which will then be rendered into the queryString which is passed as a query to <a href="https://node-postgres.com/api/pool">node-pg pool</a>.</p>
<p>The $ sign must be escaped if the template string is returned as a template literal from the module's render method.</p>
<pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>  SELECT count(1)<br>  FROM \${table}<br>  WHERE true \${filter};</span><span class="token template-punctuation string">`</span></span></code></pre>
<p>More complex modules allow for the safe substitution of parameter within the render script before returning a template string.</p>
<h2 id="layer-queries">Layer queries <a class="header-anchor" href="#layer-queries">¶</a></h2>
<p>The layer object will be retrived from the workspace if a layer key is provided as the layer URL request parameter. Access roles and filter will be applied to the reserved <code>${filter}</code> parameter. A request will terminate with a 403 status if the credentials provided with the request do not allow for access to the layer.</p>
<h2 id="post-queries">Post queries <a class="header-anchor" href="#post-queries">¶</a></h2>
<p>The <code>%{body}</code> parameter is reserved to be substituted with the post request body. If defined as an URL request parameter, <code>req.params.body</code> will replaced with the request body.</p>

    </div>

  </div>

</body>

<script>
    const toggle = document.getElementById('toggle');

    toggle.onclick = e => { e.target.parentElement.classList.toggle('show_nav'); };
</script>

</html>